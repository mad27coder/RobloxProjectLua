-- Pengaturan awal
getgenv().breakOnRaised = false

-- Services
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local VirtualUser = game:GetService("VirtualUser")
local localPlayer = Players.LocalPlayer

local marker = nil
local resetCooldown = 10
local lastResetTime = 0

-- ✅ Notifikasi saat script aktif
StarterGui:SetCore("SendNotification", {
	Title = "✅ Script Executed",
	Text = "Death marker & auto-fly enabled.",
	Duration = 4
})

-- Anti-AFK
Players.LocalPlayer.Idled:Connect(function()
	VirtualUser:CaptureController()
	VirtualUser:ClickButton1(Vector2.new(0, 0))
end)

-- Buat marker di posisi kematian
local function createDeathMarker(position)
	if marker then marker:Destroy() end

	marker = Instance.new("Part")
	marker.Anchored = true
	marker.CanCollide = false
	marker.Size = Vector3.new(1,1,1)
	marker.Position = position
	marker.Transparency = 1
	marker.Name = "DeathMarker"
	marker.Parent = workspace
end

-- Anti-sit brutal
local function destroySit(humanoid)
	task.spawn(function()
		while humanoid and humanoid.Parent do
			humanoid.Sit = false
			humanoid.SeatPart = nil
			task.wait(0.1)
		end
	end)
end

-- Fly ke marker dengan takeoff dulu
local function flyToMarker(humanoid, root)
	if not marker then return end

	local targetPos = marker.Position + Vector3.new(0, 5, 0)
	local ascendTarget = root.Position + Vector3.new(0, 5, 0)

	local bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
	bv.Velocity = Vector3.zero
	bv.Parent = root

	while (root.Position - ascendTarget).Magnitude > 0.5 do
		local direction = (ascendTarget - root.Position).Unit
		bv.Velocity = direction * 20
		task.wait(0.05)
	end

	while (root.Position - targetPos).Magnitude > 1.5 do
		local direction = (targetPos - root.Position).Unit
		bv.Velocity = direction * 30
		task.wait(0.05)
	end

	bv:Destroy()
	marker:Destroy()
	marker = nil
end

-- Character logic
localPlayer.CharacterAdded:Connect(function(char)
	local humanoid = char:WaitForChild("Humanoid")

	destroySit(humanoid)

	humanoid.Died:Connect(function()
		local root = char:FindFirstChild("HumanoidRootPart")
		if root then
			createDeathMarker(root.Position)
		end
	end)

	task.spawn(function()
		local root
		repeat
			root = char:FindFirstChild("HumanoidRootPart")
			task.wait()
		until root

		flyToMarker(humanoid, root)
	end)
end)

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "AutoGUI"
ScreenGui.ResetOnSpawn = false

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 220, 0, 120)
Frame.Position = UDim2.new(0.5, -110, 0.5, -60)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.Active = true
Frame.Draggable = true

local toggleButton = Instance.new("TextButton", ScreenGui)
toggleButton.Size = UDim2.new(0, 40, 0, 40)
toggleButton.Position = UDim2.new(1, -45, 0.5, -20)
toggleButton.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.Text = "≡"
toggleButton.ZIndex = 10
toggleButton.Active = true
toggleButton.Draggable = true

local guiVisible = true
toggleButton.MouseButton1Click:Connect(function()
	guiVisible = not guiVisible
	Frame.Visible = guiVisible
end)

-- GUI Elements
local BreakToggle = Instance.new("TextButton", Frame)
BreakToggle.Size = UDim2.new(0, 200, 0, 40)
BreakToggle.Position = UDim2.new(0, 10, 0, 10)
BreakToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
BreakToggle.TextColor3 = Color3.new(1, 1, 1)

local MarkerLabel = Instance.new("TextLabel", Frame)
MarkerLabel.Size = UDim2.new(0, 200, 0, 20)
MarkerLabel.Position = UDim2.new(0, 10, 0, 60)
MarkerLabel.BackgroundTransparency = 1
MarkerLabel.TextColor3 = Color3.new(1, 1, 1)
MarkerLabel.TextScaled = true
MarkerLabel.Text = "Marker: Belum ada"

local SignatureLabel = Instance.new("TextLabel", Frame)
SignatureLabel.Size = UDim2.new(0, 200, 0, 20)
SignatureLabel.Position = UDim2.new(0, 10, 1, -25)
SignatureLabel.BackgroundTransparency = 1
SignatureLabel.TextColor3 = Color3.new(1, 1, 1)
SignatureLabel.Text = "LYNX x DHINZ"
SignatureLabel.Font = Enum.Font.SourceSansBold
SignatureLabel.TextScaled = true

local function updateGUI()
	BreakToggle.Text = "Toggle BreakJoints (" .. (getgenv().breakOnRaised and "ON" or "OFF") .. ")"
end

local function updateMarkerLabel()
	local marker = workspace:FindFirstChild("DeathMarker")
	if marker then
		local pos = marker.Position
		MarkerLabel.Text = string.format("Marker: (%.1f, %.1f, %.1f)", pos.X, pos.Y, pos.Z)
	else
		MarkerLabel.Text = "Marker: Belum ada"
	end
end

updateGUI()
task.spawn(function()
	while true do
		updateMarkerLabel()
		task.wait(2)
	end
end)

BreakToggle.MouseButton1Click:Connect(function()
	getgenv().breakOnRaised = not getgenv().breakOnRaised
	updateGUI()
end)

-- Raised Trigger
local leaderstats = localPlayer:WaitForChild("leaderstats")
local raisedStat = leaderstats:WaitForChild("Raised")
local lastRaised = raisedStat.Value

raisedStat.Changed:Connect(function()
	local newRaised = raisedStat.Value
	local now = tick()

	if getgenv().breakOnRaised and newRaised > lastRaised and now - lastResetTime >= resetCooldown then
		local character = localPlayer.Character
		if character then
			lastResetTime = now
			character:BreakJoints()

			-- Flash effect
			local flash = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
			local frame = Instance.new("Frame", flash)
			frame.Size = UDim2.new(1, 0, 1, 0)
			frame.BackgroundColor3 = Color3.new(1, 1, 1)
			frame.BackgroundTransparency = 0
			task.spawn(function()
				for i = 0, 1, 0.1 do
					frame.BackgroundTransparency = i
					task.wait(0.05)
				end
				flash:Destroy()
			end)
		end
	end

	lastRaised = newRaised
end)